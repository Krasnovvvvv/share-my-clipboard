name: Build and Sign

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build Windows Binary
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'

    - name: Download Go dependencies
      run: go mod download

    - name: Build GUI App (no console)
      run: go build -ldflags="-H=windowsgui -s -w" -o share-my-clipboard.exe

    - name: Build Debug App (with console)
      run: go build -ldflags="-s -w" -o share-my-clipboard-debug.exe

    - name: Run Tests
      run: go test -v ./...

    - name: Code Lint
      uses: golangci/golangci-lint-action@v6
      with:
        version: v1.61
        args: --timeout=5m --out-format=colored-line-number
      continue-on-error: true

    # -------- SIGNING SECTION -------- #
    - name: Locate SignTool
      shell: pwsh
      id: signtool
      run: |
        $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\" -Recurse -ErrorAction SilentlyContinue |
        Where-Object { $_.Name -eq "signtool.exe" } |
        Select-Object -First 1 -ExpandProperty FullName
        if (!$signtool) {
        Write-Error "❌ SignTool not found in system paths!"
        exit 1
        }
        Write-Host "✅ Found SignTool at: $signtool"
        echo "signtool_path=$signtool" | Out-File -Append -FilePath $env:GITHUB_ENV

    - name: Sign Windows Binaries
      shell: pwsh
      env:
        SIGN_CERT: ${{ secrets.WIN_SIGN_CERT }}
        SIGN_PASS: ${{ secrets.WIN_SIGN_PASS }}
      run: |
        Write-Host "Signing executables..."
        $certPath = "$env:USERPROFILE\\cert.pfx"
        [System.Convert]::FromBase64String($env:SIGN_CERT) | ForEach-Object { [byte]$_ } | Set-Content -Path $certPath -AsByteStream

        $timestamp = "http://timestamp.digicert.com"
        & $env:signtool_path sign /f $certPath /p $env:SIGN_PASS /tr $timestamp /td SHA256 /fd SHA256 share-my-clipboard.exe
        & $env:signtool_path sign /f $certPath /p $env:SIGN_PASS /tr $timestamp /td SHA256 /fd SHA256 share-my-clipboard-debug.exe
        Write-Host "✅ Signing completed successfully!"


    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: signed-windows-builds
        path: |
          share-my-clipboard.exe
          share-my-clipboard-debug.exe
